var Q=Object.defineProperty,L=Object.defineProperties;var U=Object.getOwnPropertyDescriptors;var I=Object.getOwnPropertySymbols;var T=Object.prototype.hasOwnProperty,k=Object.prototype.propertyIsEnumerable;var O=Math.pow,D=(s,e,t)=>e in s?Q(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,w=(s,e)=>{for(var t in e||(e={}))T.call(e,t)&&D(s,t,e[t]);if(I)for(var t of I(e))k.call(e,t)&&D(s,t,e[t]);return s},v=(s,e)=>L(s,U(e));var _=(s,e,t)=>new Promise((n,r)=>{var o=i=>{try{c(t.next(i))}catch(h){r(h)}},u=i=>{try{c(t.throw(i))}catch(h){r(h)}},c=i=>i.done?n(i.value):Promise.resolve(i.value).then(o,u);c((t=t.apply(s,e)).next())});import{S as F}from"./index-BLjbATF-.js";function R({selected:s,correct:e,totalOptions:t,weight:n=1}){const r=new Set(e);let o=0,u=0;s.forEach(p=>{r.has(p)?o++:u++});const c=r.size,i=t-c,h=o/c-u/(i||1);return Math.max(0,Math.min(1,h))*n}function $(s,e=1){const t=O(10,e);return Math.round(s*t+Number.EPSILON)/t}function G(){return typeof crypto!="undefined"&&crypto&&typeof crypto.randomUUID=="function"?crypto.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,s=>{const e=Math.random()*16|0;return(s==="x"?e:e&3|8).toString(16)})}const A=new Map;function g(s,e={}){const t={id:G(),name:s,ts:new Date().toISOString(),payload:e,version:1};return A.has(s)&&A.get(s).forEach(n=>{try{n(t)}catch(r){console.error("Event handler error",r)}}),t}function V(s,e){return A.has(s)||A.set(s,new Set),A.get(s).add(e),()=>{var t;return(t=A.get(s))==null?void 0:t.delete(e)}}function K(s){return s?s.readRatio>=.85||!!s.manuallyMarked:!1}function Y(s){const e=[];return s!=null&&s.requiredSections&&s.requiredSections.forEach(t=>{var n;K((n=s.sectionProgress)==null?void 0:n[t])||e.push({code:"SECTION_UNREAD",id:t})}),s!=null&&s.microQuizzes&&s.microQuizzes.forEach(t=>{var n,r;(r=(n=s.microQuizState)==null?void 0:n[t])!=null&&r.passed||e.push({code:"MICRO_NOT_PASSED",id:t})}),e}function B(s){if(!s)return{status:"LOCKED",unmetCriteria:[]};const e=Y(s);return s.finalExamPassed&&s.structureSignature!==s.lastPassedSignature?{status:"OUTDATED",unmetCriteria:e}:s.cooldownUntil&&new Date(s.cooldownUntil)>new Date?{status:"COOLDOWN",unmetCriteria:e}:e.length===0?{status:s.finalExamPassed?"PASSED":"READY",unmetCriteria:[]}:{status:"LOCKED",unmetCriteria:e}}const z="assessment.attempts.v1",E="assessment.draft.v1";class H{constructor(e={maxAttemptsStored:20,pruneStrategy:"FIFO"},t=null){this.retentionPolicy=e,this.storage=t||new F("assessment")}_safeGet(e,t){try{return this.storage.get(e)||t}catch(n){return t}}getAttempts(e){return this._safeGet(z,[]).filter(n=>n.quizId===e)}saveAttempt(e){const t=this._safeGet(z,[]);t.push(e),this._prune(t,e.quizId),this.storage.set(z,t),g("quiz.attempt.save",{quizId:e.quizId,score:e.score})}submitAttemptWithRetry(e,t=3){return _(this,null,function*(){let n=0;const r=[1e3,3e3,7e3];for(;n<=t;)try{const o=this._safeGet(z,[]);return o.push(v(w({},e),{status:"SAVED",savedAt:new Date().toISOString()})),this.storage.set(z,o),g("quiz.submit",{quizId:e.quizId,status:"SAVED"}),{status:"SAVED"}}catch(o){if(n+=1,n>t){const c=v(w({},e),{status:"PENDING_SYNC",createdAt:new Date().toISOString()}),i=this._safeGet(z,[]);i.push(c);try{this.storage.set(z,i)}catch(h){}return g("quiz.attempt.pending",{quizId:e.quizId}),{status:"PENDING_SYNC"}}const u=r[Math.min(n-1,r.length-1)];yield new Promise(c=>setTimeout(c,u))}})}_prune(e,t){const n=e.filter(r=>r.quizId===t);if(n.length>this.retentionPolicy.maxAttemptsStored){const r=n.length-this.retentionPolicy.maxAttemptsStored;let o=0;for(let u=0;u<e.length&&o<r;u++)e[u].quizId===t&&(e.splice(u,1),u--,o++);g("quiz.attempt.pruned",{quizId:t,removed:r})}}scoreQuiz(e,t){let n=0,r=0;const o=[];(e.questions||[]).forEach(i=>{var d,l;const h=typeof i.weight=="number"?i.weight:1;n+=h*100;const m=(t||[]).find(a=>a.questionId===i.id);if(!m){o.push({questionId:i.id,score:0});return}let p=0;const f=(l=(d=i.correctAnswer)!=null?d:i.correct)!=null?l:i.answer;try{if(i.type==="multiple-choice"){const a=Array.isArray(m.selected)?m.selected:m.selected?[m.selected]:[],q=Array.isArray(f)?f:f?[f]:[];p=R({selected:a,correct:q,totalOptions:(i.options||[]).length,weight:1})}else if(i.type==="single-choice"||i.type==="true-false"){const a=Array.isArray(f)?f[0]:f;p=m.selected===a?1:0}else p=0}catch(a){p=0,g("quiz.scoring.error",{quizId:e.id,questionId:i.id,error:String(a)})}const b=Number.isFinite(p)?Math.min(100,p*h*100):0;r+=b,o.push({questionId:i.id,score:b})});const u=n>0&&Number.isFinite(r)?r/n*100:0;let c=$(u,1);return(!Number.isFinite(c)||Number.isNaN(c))&&(c=0),{finalScore:c,questionScores:o}}startDraft(e,t){const n=this._safeGet(E,{});n[e]=v(w({},t),{updatedAt:new Date().toISOString()}),this.storage.set(E,n)}clearDraft(e){const t=this._safeGet(E,{});delete t[e],this.storage.set(E,t)}getDraft(e){return this._safeGet(E,{})[e]||null}evaluateModule(e){return B(e)}}const P=new H,W={"quiz.locked.title":"Final exam locked","quiz.locked.reason.SECTION_UNREAD":"Some required sections are not sufficiently read.","quiz.locked.reason.MICRO_NOT_PASSED":"All micro-quizzes must be passed.","quiz.cooldown.message":"Please wait until the cooldown ends before retrying the final exam.","quiz.result.passed":"Passed","quiz.result.failed":"Not passed","quiz.extra.enOnly":"This key exists only in English","quiz.resultsAvailable":"Quiz results available","quiz.submissionPending":"Quiz submission pending","quiz.submit.button":"Submit","quiz.result.label":"Result"},j={"quiz.locked.title":"Abschlussprüfung gesperrt","quiz.locked.reason.SECTION_UNREAD":"Einige erforderliche Abschnitte sind nicht ausreichend gelesen.","quiz.locked.reason.MICRO_NOT_PASSED":"Alle Mikro-Quizze müssen bestanden sein.","quiz.cooldown.message":"Bitte warte bis die Abkühlphase endet bevor du die Abschlussprüfung erneut versuchst.","quiz.result.passed":"Bestanden","quiz.result.failed":"Nicht bestanden","quiz.resultsAvailable":"Quiz-Ergebnisse sind verfügbar","quiz.submissionPending":"Quizübermittlung ausstehend","quiz.submit.button":"Abschicken","quiz.result.label":"Ergebnis"},C={en:W,de:j};let M="en";function N(s){const e=C[M]||C.en;if(e[s])return e[s];if(C.en[s])return C.en[s];try{g("i18n.missing",{key:s,locale:M})}catch(t){console.warn("Could not emit i18n.missing event",t)}return s}class J{constructor(){this.node=null,this._init(),this._unsub=V("quiz.submit",this._onQuizSubmit.bind(this)),typeof window!="undefined"&&typeof window.addEventListener=="function"&&(this._onUnload=this.destroy.bind(this),window.addEventListener("beforeunload",this._onUnload))}_init(){if(typeof document=="undefined")return;const e=document.getElementById("assessment-live-region");if(e){this.node=e;return}this.node=document.createElement("div"),this.node.id="assessment-live-region",this.node.setAttribute("aria-live","polite"),this.node.setAttribute("aria-atomic","true"),this.node.setAttribute("role","status"),this.node.style.position="absolute",this.node.style.left="-9999px",this.node.style.width="1px",this.node.style.height="1px",this.node.style.overflow="hidden",document.body.appendChild(this.node)}_onQuizSubmit(e){const t=e&&e.payload||{},n="quiz.resultsAvailable",r="quiz.submissionPending";let o="";try{o=t.status==="SAVED"?N(n)||"Quiz results available":N(r)||"Quiz submission pending"}catch(i){o=t.status==="SAVED"?"Quiz results available":"Quiz submission pending"}let u=o;if(typeof t.score=="number"){const i=Math.round(t.score*10)/10;u=`${o} — Score: ${i}%`}this.node&&(this.node.textContent=u);const c=document.querySelector(".quiz-results-heading");c&&(c.hasAttribute("tabindex")||c.setAttribute("tabindex","-1"),typeof c.focus=="function"&&c.focus())}destroy(){try{this._unsub&&typeof this._unsub=="function"&&this._unsub(),typeof window!="undefined"&&this._onUnload&&window.removeEventListener("beforeunload",this._onUnload),this.node&&this.node.parentNode&&this.node.parentNode.removeChild(this.node)}catch(e){console.warn("A11yAnnouncer cleanup error",e)}finally{this.node=null,this._unsub=null}}}const X=new J;class te{constructor(e){this.container=e,this.root=document.createElement("div"),this.root.className="micro-quiz-panel"}render(e,t={}){this.quiz=e,this.moduleState=t,this.root.innerHTML="";const n=document.createElement("h3");n.textContent=e.title||"Micro-Quiz",this.root.appendChild(n);const r=document.createElement("form");r.className="micro-quiz-form",r.setAttribute("aria-labelledby",n.id||""),e.questions.slice(0,5).forEach((u,c)=>{const i=document.createElement("fieldset"),h=document.createElement("legend");h.textContent=u.question,i.appendChild(h),(u.options||[]).forEach(p=>{const f=document.createElement("label"),b=document.createElement("input");b.type=u.type==="multiple-choice"?"checkbox":"radio",b.name=`q-${u.id}`,b.value=p,f.appendChild(b),f.appendChild(document.createTextNode(p)),i.appendChild(f)}),r.appendChild(i)});const o=document.createElement("button");o.type="button",o.textContent=N("quiz.submit.button")||"Submit",o.addEventListener("click",()=>this._onSubmit(r)),r.appendChild(o),this.root.appendChild(r),this.container.appendChild(this.root),g("quiz.view",{quizId:e.id})}_gatherAnswers(e){const t=[];return this.quiz.questions.slice(0,5).forEach(r=>{const o=`q-${r.id}`,u=Array.from(e.querySelectorAll(`[name="${o}"]`));if(r.type==="multiple-choice"){const c=u.filter(i=>i.checked).map(i=>i.value);t.push({questionId:r.id,selected:c})}else{const c=u.find(i=>i.checked);t.push({questionId:r.id,selected:c?c.value:null})}}),t}_onSubmit(e){return _(this,null,function*(){g("quiz.start",{quizId:this.quiz.id});const t=this._gatherAnswers(e),n=P.scoreQuiz(this.quiz,t),r={quizId:this.quiz.id,answers:t,score:n.finalScore,date:new Date().toISOString()},o=yield P.submitAttemptWithRetry(r),c=Array.from(this.root.querySelectorAll(".quiz-results-heading"));let i=c.length>0?c[0]:null;const m=(n.questionScores||[]).reduce((d,l)=>d+(Number.isFinite(l.score)?l.score:0),0),p=(this.quiz.questions||[]).reduce((d,l)=>d+(l.weight||1)*100,0),f=Number.isFinite(n.finalScore)&&!Number.isNaN(n.finalScore)?n.finalScore:p>0?Number((m/p*100).toFixed(1)):0,b=`${N("quiz.result.label")||"Result"}: ${f}% (${Math.round(m)}/${Math.round(p)} pts)`;if(i)i.textContent=b,c.slice(1).forEach(d=>{d&&d.parentNode&&d.parentNode.removeChild(d)});else{i=document.createElement("h4"),i.className="quiz-results-heading",i.tabIndex=-1,i.textContent=b;const d=this.root.querySelector("form");d&&d.parentNode?d.parentNode.insertBefore(i,d.nextSibling):this.root.appendChild(i)}g("quiz.submit",{quizId:this.quiz.id,status:o.status,score:f});try{this._highlightResults(n,e)}catch(d){console.warn("Failed to highlight quiz results",d)}})}_highlightResults(e,t){if(!this.quiz||!t)return;const n=this.quiz.questions.slice(0,5),r=e&&e.questionScores?e.questionScores.reduce((o,u)=>(o[u.questionId]=u.score,o),{}):{};n.forEach(o=>{var b,d;const u=`q-${o.id}`,c=Array.from(t.querySelectorAll(`[name="${u}"]`));if(!c||c.length===0)return;const i=(d=(b=o.correctAnswer)!=null?b:o.correct)!=null?d:o.answer,h=Array.isArray(i)?i:i!=null?[i]:[],m=new Set(h),f=(Number.isFinite(r[o.id])?r[o.id]:0)>=99.5;c.forEach(l=>{let a=l.closest("label");a||(a=l.parentElement);const q=l.value,x=m.has(q),S=!!l.checked;if(a&&a.classList.remove("correct-option","incorrect-selected"),x){if(a&&a.classList.add("correct-option"),l.setAttribute("data-correct","true"),a&&!a.querySelector(".result-badge")){const y=document.createElement("span");y.className="result-badge correct-badge",y.textContent="Correct",a.appendChild(y)}a&&(a.style.backgroundColor="#e6ffed",a.style.borderLeft="4px solid #28a745",a.style.paddingLeft="6px")}if(!x&&S){if(a&&a.classList.add("incorrect-selected"),l.setAttribute("aria-invalid","true"),a&&!a.querySelector(".result-badge")){const y=document.createElement("span");y.className="result-badge incorrect-badge",y.textContent="Incorrect",a.appendChild(y)}a&&(a.style.backgroundColor="#fff0f0",a.style.borderLeft="4px solid #d93025",a.style.paddingLeft="6px")}l.disabled=!0});try{const l=c[0]&&c[0].closest("fieldset");if(l){const a=l.querySelector(".question-result-note");a&&a.remove();const q=l.querySelector(".correct-answers-list");q&&q.remove();const x=document.createElement("div");if(x.className="question-result-note sr-only",x.textContent=f?"Question answered correctly":"Question has incorrect selections",l.appendChild(x),!f&&h.length>0){const S=document.createElement("div");S.className="correct-answers-list",S.textContent="Correct answer(s): "+h.join(", "),l.appendChild(S)}}}catch(l){}});try{this.root.classList.add("answered")}catch(o){}}destroy(){this.root&&this.root.parentNode&&this.root.parentNode.removeChild(this.root);try{X.destroy()}catch(e){}}}export{te as default};
//# sourceMappingURL=MicroQuizPanel-DCB6zszV.js.map
